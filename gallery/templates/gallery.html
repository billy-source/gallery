{% extends 'base.html' %}
{% load static %}

{% block title %}Gallery{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-2xl font-bold mb-4">Filter by Tags</h2>
    <div class="flex flex-wrap gap-2">
        {% for tag in tags %}
            <a href="{% url 'gallery' %}?tag={{ tag|urlencode }}"
               class="px-4 py-2 rounded-full transition-colors duration-200 {% if tag in selected_tags %}bg-blue-600 text-white{% else %}bg-gray-700 text-gray-300 hover:bg-gray-600{% endif %}">
                {{ tag }}
            </a>
        {% endfor %}
    </div>
</div>

<section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    {% for photo in photos %}
    <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden transform transition-transform duration-300 hover:scale-105">
        <a href="{% url 'photo_detail' photo.id %}">
            <img src="{{ photo.image.url }}" alt="{{ photo.title }}" class="w-full h-48 object-cover">
        </a>
        <div class="p-4 flex flex-col justify-between h-32">
            <div>
                <h3 class="text-white text-lg font-bold">{{ photo.title }}</h3>

                {# Temporary: just show the raw tags string until we add a split filter #}
                <p class="text-gray-400 text-sm mt-2">{{ photo.tags }}</p>
            </div>

            <div class="flex justify-between items-center mt-2">
                <span class="text-sm text-gray-400">{{ photo.likes.count }} Likes</span>
                <button
                    aria-label="Like {{ photo.title }}"
                    data-photo-id="{{ photo.id }}"
                    class="like-button p-2 rounded-full transition-colors duration-200 {% if user.is_authenticated and user in photo.likes.all %}text-red-500 bg-red-100{% else %}text-gray-400 hover:bg-gray-700{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    {% empty %}
        <p class="text-gray-400">No photos available.</p>
    {% endfor %}
</section>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', async (e) => {
            const photoId = e.currentTarget.dataset.photoId;
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            const response = await fetch(`/like/${photoId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            });
            if (response.ok) {
                const data = await response.json();
                const likesCountSpan = e.currentTarget.parentNode.querySelector('span');
                likesCountSpan.textContent = `${data.likes_count} Likes`;

                if (data.is_liked) {
                    e.currentTarget.classList.add('text-red-500', 'bg-red-100');
                    e.currentTarget.classList.remove('text-gray-400', 'hover:bg-gray-700');
                } else {
                    e.currentTarget.classList.remove('text-red-500', 'bg-red-100');
                    e.currentTarget.classList.add('text-gray-400', 'hover:bg-gray-700');
                }
            }
        });
    });
});
</script>
{% endblock %}
